-- Tabla de Eventos
CREATE TABLE Eventos (
    ID INT PRIMARY KEY IDENTITY,
    Nombre NVARCHAR(100) NOT NULL,
    Descripcion TEXT NULL,
    Fecha DATETIME NOT NULL,
    Lugar NVARCHAR(100) NOT NULL,
    CapacidadTotal INT NOT NULL,
    Estado NVARCHAR(50) NOT NULL,
    FechaCreacion DATETIME NOT NULL DEFAULT GETDATE(),
    CreadoPor INT NOT NULL
);

-- Tabla de Localidades
CREATE TABLE Localidades (
    ID INT PRIMARY KEY IDENTITY,
    EventoID INT NOT NULL FOREIGN KEY REFERENCES Eventos(ID),
    Nombre NVARCHAR(50) NOT NULL,
    Capacidad INT NOT NULL,
    Precio DECIMAL(10,2) NOT NULL,
    EsNumerada BIT NOT NULL
);

-- Tabla de Usuarios
CREATE TABLE Usuarios (
    ID INT PRIMARY KEY IDENTITY,
    Username NVARCHAR(50) NOT NULL UNIQUE,
    PasswordHash VARBINARY(256) NOT NULL,
    Rol NVARCHAR(20) NOT NULL CHECK (Rol IN ('Cliente', 'Administrador')),
    Email NVARCHAR(100) NOT NULL UNIQUE,
    FechaRegistro DATETIME NOT NULL DEFAULT GETDATE(),
    Estado NVARCHAR(50) NOT NULL
);

-- Tabla de Reservas
CREATE TABLE Reservas (
    ID INT PRIMARY KEY IDENTITY,
    UsuarioID INT NOT NULL FOREIGN KEY REFERENCES Usuarios(ID),
    EventoID INT NOT NULL FOREIGN KEY REFERENCES Eventos(ID),
    LocalidadID INT NOT NULL FOREIGN KEY REFERENCES Localidades(ID),
    Cantidad INT NOT NULL,
    FechaReserva DATETIME NOT NULL DEFAULT GETDATE(),
    Estado NVARCHAR(50) NOT NULL
);

-- Tabla de Bloqueos
CREATE TABLE Bloqueos (
    ID INT PRIMARY KEY IDENTITY,
    LocalidadID INT NOT NULL FOREIGN KEY REFERENCES Localidades(ID),
    Fila NVARCHAR(10) NULL,
    Asiento NVARCHAR(10) NULL,
    Cantidad INT NOT NULL,
    FechaBloqueo DATETIME NOT NULL DEFAULT GETDATE(),
    Motivo NVARCHAR(100) NULL,
    Estado NVARCHAR(50) NOT NULL
);

CREATE TABLE BDTICKETS.dbo.US_Roles (
	ID int IDENTITY(1,1) NOT NULL,
	Nombre nvarchar(20) COLLATE Modern_Spanish_CI_AS NOT NULL,
	Descripcion nvarchar(255) COLLATE Modern_Spanish_CI_AS NULL,
	Activo bit DEFAULT 1 NULL,
	CONSTRAINT PK__US_Roles__3214EC278AFFD1DC PRIMARY KEY (ID),
	CONSTRAINT UQ__US_Roles__75E3EFCFDEBC74BC UNIQUE (Nombre)
);

CREATE TABLE BDTICKETS.dbo.US_Usuarios (
	ID int IDENTITY(1,1) NOT NULL,
	Username nvarchar(50) COLLATE Modern_Spanish_CI_AS NOT NULL,
	PasswordHash varbinary(256) NOT NULL,
	Salt varbinary(256) NOT NULL,
	RolID int NULL,
	Email nvarchar(100) COLLATE Modern_Spanish_CI_AS NOT NULL,
	FechaRegistro datetime DEFAULT getdate() NOT NULL,
	Estado bit NOT NULL,
	UltimoLogin datetime NULL,
	IntentosFallidos int DEFAULT 0 NULL,
	Bloqueado bit DEFAULT 0 NULL,
	TokenRecuperacion nvarchar(256) COLLATE Modern_Spanish_CI_AS NULL,
	FechaExpiracionToken datetime NULL,
	CONSTRAINT PK__US_Usuar__3214EC27BDEAB95C PRIMARY KEY (ID),
	CONSTRAINT UQ__US_Usuar__536C85E477E33E41 UNIQUE (Username),
	CONSTRAINT UQ__US_Usuar__A9D10534BFD8ED7E UNIQUE (Email),
	CONSTRAINT FK__US_Usuari__RolID__5535A963 FOREIGN KEY (RolID) REFERENCES BDTICKETS.dbo.US_Roles(ID)
);


CREATE TABLE BDTICKETS.dbo.LogsErrores (
	ID int IDENTITY(1,1) NOT NULL,
	FechaHora datetime DEFAULT getdate() NOT NULL,
	Procedimiento nvarchar(100) COLLATE Modern_Spanish_CI_AS NULL,
	Mensaje nvarchar(4000) COLLATE Modern_Spanish_CI_AS NULL,
	Severidad int NULL,
	Estado int NULL,
	UsuarioID int NULL,
	Detalle nvarchar(MAX) COLLATE Modern_Spanish_CI_AS NULL,
	CONSTRAINT PK__LogsErro__3214EC27CE05A510 PRIMARY KEY (ID)
);